/*
 * This Java source file was generated by the Gradle 'init' task.
 */
package gradle_tish_embedded;

import org.apache.catalina.Context;
import org.apache.catalina.LifecycleException;
import org.apache.catalina.connector.Connector;
import org.apache.catalina.startup.Tomcat;
import org.apache.coyote.http11.Http11Nio2Protocol;




import java.io.File;
import java.io.FileInputStream;
import java.io.IOException;
import java.util.Properties;

public class App {
    public static Properties prop;
    public static void main(String[] args) throws Exception {
        easyMain(args);
    }
    public static void easyMain(String[] args)
            throws Exception {
        Tomcat tomcat = new Tomcat();

        prop = new Properties();
        String fileName = "./src/main/resources/app.properties";
        FileInputStream fis = new FileInputStream(fileName);
        prop.load(fis);

        int port = Integer.parseInt(prop.getProperty("port"));
        String hostname = App.prop.getProperty("hostname");
        String keyStorePass = App.prop.getProperty("keyStorePass");
        tomcat.setHostname(hostname);

        // idk why we need this connector, maybe for connecting via http?
        System.out.println(System.getProperty("user.dir"));
        Http11Nio2Protocol protocolHandler = new Http11Nio2Protocol();
        protocolHandler.setPort(port);
        protocolHandler.setSSLEnabled(true);
        // protocolHandler.setSSL(true);
        protocolHandler.setKeystoreFile("../src/main/resources/demoKey");
        protocolHandler.setKeystorePass(keyStorePass);
        protocolHandler.setKeyAlias("mykey");
        // protocolHandler.setSSLVerifyClient(Boolean.toString(true));
        System.out.println(protocolHandler.isSSLEnabled());
        Connector conn = new Connector(protocolHandler);
        tomcat.setConnector(conn);


        Context ctx = tomcat.addWebapp("", new File("./src/main/resources").getAbsolutePath());
        // by default jndi is disabled in tomcat embedded
        tomcat.enableNaming();

        // set config file for ctx must be done first be4 being registered to the virtual host
        // the minor difference between addWebapp and addContext is addWebApp also 
        // include a context.xml and web.xml while addContext doesnt

        // Tomcat.addServlet(ctx, "hello", new HelloServlet());
        // Tomcat.addServlet(ctx, "userList", new UserListServlet());
        // ctx.addServletMappingDecoded("/*", "hello");
        // ctx.addServletMappingDecoded("/list", "userList");

        // A problem when connecting to postgres is that you need to have an 
        // org.apache.tomcat.dbcp.dbcp2.BasicDataSourceFactory 

        
        tomcat.start();
        tomcat.getServer().await();
    }
 
}
